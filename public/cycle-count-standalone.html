<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouse Cycle Count</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <style>
    .bg-primary { background-color: #1a56db; }
    .bg-primary-light { background-color: #2563eb; }
    .text-primary { color: #1a56db; }
    .bg-accent { background-color: #f97316; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
    .progress-bar { height: 8px; border-radius: 4px; }
    .progress-value { height: 8px; border-radius: 4px; background-color: #2563eb; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
    .badge-blue { background-color: #e0f2fe; color: #0369a1; }
    .badge-yellow { background-color: #fef9c3; color: #854d0e; }
    .badge-green { background-color: #dcfce7; color: #15803d; }
    .badge-gray { background-color: #f3f4f6; color: #4b5563; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <h1 class="text-xl font-bold">Warehouse Cycle Count</h1>
      </div>
      <nav>
        <a href="/warehouse-dashboard" class="text-gray-600 hover:text-primary transition">Back to Dashboard</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
      <div>
        <h2 class="text-2xl md:text-3xl font-bold tracking-tight">Cycle Counting</h2>
        <p class="text-sm md:text-base text-gray-500">
          Manage inventory accuracy through systematic cycle counts
        </p>
      </div>
      <div>
        <button id="createCycleCount" class="bg-primary hover:bg-primary-light text-white px-4 py-2 rounded-md flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          New Cycle Count
        </button>
      </div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
      <div class="flex flex-col sm:flex-row justify-between gap-4 mb-4">
        <div class="flex-1 flex gap-2">
          <div class="relative flex-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-2.5 top-2.5 h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="search" placeholder="Search cycle counts..." class="pl-8 pr-4 py-2 border border-gray-300 rounded-md w-full" id="searchInput">
          </div>
          <select class="border border-gray-300 rounded-md px-4 py-2 w-40" id="statusFilter">
            <option value="all">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>

      <div class="grid-container" id="cycleCountsContainer">
        <!-- Cycle count cards will be inserted here dynamically -->
      </div>
    </div>

    <div id="detailsContainer" class="bg-white p-6 rounded-lg shadow-sm mb-6 hidden">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold" id="detailsTitle">Count Details</h3>
        <button id="backToList" class="text-gray-600 hover:text-primary transition">
          Back to List
        </button>
      </div>
      <div class="mb-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
          <div class="mb-2 md:mb-0">
            <span class="text-gray-500">Status:</span>
            <span class="badge ml-2" id="detailsStatus">Pending</span>
          </div>
          <div>
            <span class="text-gray-500">Progress:</span>
            <span class="ml-2 font-medium" id="detailsProgress">0%</span>
          </div>
        </div>
        <div class="mt-2 w-full bg-gray-200 rounded-full progress-bar">
          <div class="progress-value" id="detailsProgressBar" style="width: 0%"></div>
        </div>
      </div>

      <div class="border rounded-md overflow-hidden">
        <table class="w-full text-left">
          <thead class="bg-gray-50 text-gray-600 text-sm border-b">
            <tr>
              <th class="px-4 py-3">Item</th>
              <th class="px-4 py-3">SKU</th>
              <th class="px-4 py-3">Location</th>
              <th class="px-4 py-3">Expected</th>
              <th class="px-4 py-3">Actual</th>
              <th class="px-4 py-3">Status</th>
              <th class="px-4 py-3">Actions</th>
            </tr>
          </thead>
          <tbody id="detailsItems">
            <!-- Count items will be inserted here dynamically -->
          </tbody>
        </table>
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <button id="completeCountButton" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 hidden">
          Complete Count
        </button>
        <button id="applyAdjustmentsButton" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 hidden">
          Apply Adjustments
        </button>
      </div>
    </div>

    <div id="countItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-semibold mb-4">Record Count</h3>
        <p class="mb-2" id="modalItemName">Item: Smartphone</p>
        <p class="mb-4" id="modalExpectedQty">Expected Quantity: 50</p>
        <div class="mb-4">
          <label for="actualQty" class="block text-sm font-medium text-gray-700 mb-1">Actual Quantity</label>
          <input type="number" id="actualQty" class="w-full border border-gray-300 rounded-md px-3 py-2" min="0">
        </div>
        <div class="flex justify-end gap-2">
          <button id="modalCancel" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
            Cancel
          </button>
          <button id="modalSave" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-light">
            Save
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Sample data for cycle counts
    const cycleCounts = [
      {
        id: 1,
        name: "Monthly Electronics Count",
        countingMethod: "cycle",
        status: "pending",
        scheduledDate: "2025-03-25",
        assignedTo: "John Doe",
        locations: [1, 2, 3],
        items: [
          { id: 101, sku: "ELEC-001", productName: "Smartphone", locationName: "Aisle A, Rack 1", expectedQuantity: 50, status: "pending" },
          { id: 102, sku: "ELEC-002", productName: "Tablet", locationName: "Aisle A, Rack 2", expectedQuantity: 25, status: "pending" },
          { id: 103, sku: "ELEC-003", productName: "Laptop", locationName: "Aisle A, Rack 3", expectedQuantity: 15, status: "pending" }
        ]
      },
      {
        id: 2,
        name: "Weekly Food Inventory",
        countingMethod: "cycle",
        status: "in_progress",
        scheduledDate: "2025-03-22",
        assignedTo: "Jane Smith",
        startedAt: "2025-03-22T08:00:00",
        locations: [4, 5],
        items: [
          { id: 201, sku: "FOOD-001", productName: "Rice", locationName: "Aisle B, Rack 1", expectedQuantity: 100, status: "counted", actualQuantity: 95 },
          { id: 202, sku: "FOOD-002", productName: "Pasta", locationName: "Aisle B, Rack 2", expectedQuantity: 80, status: "pending" },
          { id: 203, sku: "FOOD-003", productName: "Cereal", locationName: "Aisle B, Rack 3", expectedQuantity: 65, status: "counted", actualQuantity: 63 }
        ]
      },
      {
        id: 3,
        name: "Quarterly Full Inventory",
        countingMethod: "full",
        status: "completed",
        scheduledDate: "2025-03-15",
        assignedTo: "Robert Johnson",
        startedAt: "2025-03-15T09:00:00",
        completedAt: "2025-03-15T17:00:00",
        locations: [1, 2, 3, 4, 5, 6, 7, 8],
        items: [
          { id: 301, sku: "ELEC-001", productName: "Smartphone", locationName: "Aisle A, Rack 1", expectedQuantity: 50, status: "counted", actualQuantity: 48 },
          { id: 302, sku: "ELEC-002", productName: "Tablet", locationName: "Aisle A, Rack 2", expectedQuantity: 25, status: "counted", actualQuantity: 25 },
          { id: 303, sku: "FOOD-001", productName: "Rice", locationName: "Aisle B, Rack 1", expectedQuantity: 100, status: "counted", actualQuantity: 92 }
        ]
      }
    ];

    // DOM elements
    const cycleCountsContainer = document.getElementById('cycleCountsContainer');
    const detailsContainer = document.getElementById('detailsContainer');
    const detailsTitle = document.getElementById('detailsTitle');
    const detailsStatus = document.getElementById('detailsStatus');
    const detailsProgress = document.getElementById('detailsProgress');
    const detailsProgressBar = document.getElementById('detailsProgressBar');
    const detailsItems = document.getElementById('detailsItems');
    const backToList = document.getElementById('backToList');
    const completeCountButton = document.getElementById('completeCountButton');
    const applyAdjustmentsButton = document.getElementById('applyAdjustmentsButton');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const countItemModal = document.getElementById('countItemModal');
    const modalItemName = document.getElementById('modalItemName');
    const modalExpectedQty = document.getElementById('modalExpectedQty');
    const actualQtyInput = document.getElementById('actualQty');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');

    let selectedCount = null;
    let selectedItem = null;

    // Format date
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }

    // Calculate progress percentage
    function calculateProgress(items) {
      if (!items || items.length === 0) return 0;
      const countedItems = items.filter(item => 
        item.status === "counted" || item.status === "adjusted"
      ).length;
      return Math.round((countedItems / items.length) * 100);
    }

    // Get appropriate badge class based on status
    function getStatusBadgeClass(status) {
      switch (status) {
        case "pending": return "badge-blue";
        case "in_progress": return "badge-yellow";
        case "completed": return "badge-green";
        case "cancelled": return "badge-gray";
        default: return "badge-gray";
      }
    }

    // Get status display name
    function formatStatus(status) {
      switch (status) {
        case "pending": return "Pending";
        case "in_progress": return "In Progress";
        case "completed": return "Completed";
        case "cancelled": return "Cancelled";
        case "counted": return "Counted";
        case "adjusted": return "Adjusted";
        default: return status;
      }
    }

    // Render cycle count cards
    function renderCycleCounts() {
      const searchTerm = searchInput.value.toLowerCase();
      const statusValue = statusFilter.value;
      
      const filteredCounts = cycleCounts.filter(count => {
        const matchesSearch = count.name.toLowerCase().includes(searchTerm);
        const matchesStatus = statusValue === 'all' || count.status === statusValue;
        return matchesSearch && matchesStatus;
      });
      
      cycleCountsContainer.innerHTML = '';
      
      if (filteredCounts.length === 0) {
        cycleCountsContainer.innerHTML = `
          <div class="col-span-full text-center py-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h3 class="mt-2 text-lg font-medium">No cycle counts found</h3>
            <p class="mt-1 text-gray-500">Try adjusting your search or filters</p>
          </div>
        `;
        return;
      }
      
      filteredCounts.forEach(count => {
        const progressPercentage = calculateProgress(count.items);
        const badgeClass = getStatusBadgeClass(count.status);
        
        const card = document.createElement('div');
        card.className = 'bg-white border rounded-lg overflow-hidden shadow-sm';
        card.innerHTML = `
          <div class="p-4">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-semibold">${count.name}</h3>
                <p class="text-sm text-gray-500">${count.countingMethod === 'cycle' ? 'Cycle Count' : 'Full Count'}</p>
              </div>
              <span class="badge ${badgeClass}">${formatStatus(count.status)}</span>
            </div>
            <div class="mt-4 space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Scheduled for:</span>
                <span class="font-medium">${formatDate(count.scheduledDate)}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Assigned to:</span>
                <span class="font-medium">${count.assignedTo}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Items to count:</span>
                <span class="font-medium">${count.items.length}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Progress:</span>
                <span class="font-medium">${progressPercentage}%</span>
              </div>
              <div class="mt-2 pt-2 border-t">
                <div class="w-full bg-gray-200 rounded-full progress-bar">
                  <div class="progress-value" style="width: ${progressPercentage}%"></div>
                </div>
              </div>
            </div>
            <div class="flex justify-end mt-4">
              <button class="view-details px-3 py-1.5 bg-primary text-white text-sm rounded hover:bg-primary-light" 
                      data-id="${count.id}">
                ${count.status === "pending" ? "Start" : 
                  count.status === "in_progress" ? "Continue" : "View"}
              </button>
            </div>
          </div>
        `;
        
        cycleCountsContainer.appendChild(card);
        
        // Add event listener to view details button
        const viewButton = card.querySelector('.view-details');
        viewButton.addEventListener('click', () => viewCycleCountDetails(count.id));
      });
    }

    // Render cycle count details
    function renderCycleCountDetails(count) {
      selectedCount = count;
      const progressPercentage = calculateProgress(count.items);
      
      detailsTitle.textContent = count.name;
      detailsStatus.textContent = formatStatus(count.status);
      detailsStatus.className = `badge ${getStatusBadgeClass(count.status)}`;
      detailsProgress.textContent = `${progressPercentage}%`;
      detailsProgressBar.style.width = `${progressPercentage}%`;
      
      // Show/hide action buttons based on status
      if (count.status === "in_progress") {
        completeCountButton.classList.remove('hidden');
        
        // Only show adjustments button if there are counted items
        if (count.items.some(item => item.status === "counted")) {
          applyAdjustmentsButton.classList.remove('hidden');
        } else {
          applyAdjustmentsButton.classList.add('hidden');
        }
      } else {
        completeCountButton.classList.add('hidden');
        applyAdjustmentsButton.classList.add('hidden');
      }
      
      // Render items table
      detailsItems.innerHTML = '';
      count.items.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        
        const discrepancy = item.actualQuantity !== undefined 
          ? item.actualQuantity - item.expectedQuantity 
          : null;
        
        row.innerHTML = `
          <td class="px-4 py-3">${item.productName}</td>
          <td class="px-4 py-3">${item.sku}</td>
          <td class="px-4 py-3">${item.locationName}</td>
          <td class="px-4 py-3">${item.expectedQuantity}</td>
          <td class="px-4 py-3">
            ${item.actualQuantity !== undefined ? item.actualQuantity : '-'}
            ${discrepancy !== null 
              ? `<span class="${discrepancy < 0 ? 'text-red-600' : discrepancy > 0 ? 'text-green-600' : ''}">(${discrepancy > 0 ? '+' : ''}${discrepancy})</span>` 
              : ''}
          </td>
          <td class="px-4 py-3">
            <span class="badge ${getStatusBadgeClass(item.status)}">${formatStatus(item.status)}</span>
          </td>
          <td class="px-4 py-3">
            ${count.status === "in_progress" && item.status === "pending" 
              ? `<button class="record-count px-3 py-1 bg-blue-100 text-blue-800 text-xs rounded hover:bg-blue-200" data-id="${item.id}">Record</button>` 
              : ''}
          </td>
        `;
        
        detailsItems.appendChild(row);
        
        // Add event listener to record count button
        if (count.status === "in_progress" && item.status === "pending") {
          const recordButton = row.querySelector('.record-count');
          recordButton.addEventListener('click', () => openRecordCountModal(item));
        }
      });
      
      // Show details container and hide list container
      detailsContainer.classList.remove('hidden');
      cycleCountsContainer.parentElement.classList.add('hidden');
    }

    // View cycle count details
    function viewCycleCountDetails(countId) {
      const count = cycleCounts.find(c => c.id === countId);
      if (!count) return;
      
      // If status is pending, start the count
      if (count.status === "pending") {
        count.status = "in_progress";
        count.startedAt = new Date().toISOString();
      }
      
      renderCycleCountDetails(count);
    }

    // Open record count modal
    function openRecordCountModal(item) {
      selectedItem = item;
      modalItemName.textContent = `Item: ${item.productName}`;
      modalExpectedQty.textContent = `Expected Quantity: ${item.expectedQuantity}`;
      actualQtyInput.value = '';
      countItemModal.classList.remove('hidden');
    }

    // Save count record
    function saveCountRecord() {
      if (!selectedItem) return;
      
      const actualQty = parseInt(actualQtyInput.value);
      if (isNaN(actualQty) || actualQty < 0) {
        alert('Please enter a valid quantity');
        return;
      }
      
      selectedItem.actualQuantity = actualQty;
      selectedItem.status = "counted";
      
      // Close modal
      countItemModal.classList.add('hidden');
      
      // Re-render details
      renderCycleCountDetails(selectedCount);
    }

    // Complete cycle count
    function completeCycleCount() {
      if (!selectedCount) return;
      
      // Check if all items are counted
      const allCounted = selectedCount.items.every(item => item.status === "counted" || item.status === "adjusted");
      
      if (!allCounted) {
        alert('Cannot complete cycle count. Some items are not counted yet.');
        return;
      }
      
      selectedCount.status = "completed";
      selectedCount.completedAt = new Date().toISOString();
      
      // Re-render details
      renderCycleCountDetails(selectedCount);
      
      alert('Cycle count completed successfully!');
    }

    // Apply inventory adjustments
    function applyAdjustments() {
      if (!selectedCount) return;
      
      // Count items with discrepancies
      const itemsWithDiscrepancies = selectedCount.items.filter(item => 
        item.status === "counted" && item.actualQuantity !== item.expectedQuantity
      );
      
      if (itemsWithDiscrepancies.length === 0) {
        alert('No inventory adjustments needed.');
        return;
      }
      
      // Mark items as adjusted
      itemsWithDiscrepancies.forEach(item => {
        item.status = "adjusted";
      });
      
      // Re-render details
      renderCycleCountDetails(selectedCount);
      
      alert(`Inventory adjustments applied for ${itemsWithDiscrepancies.length} items!`);
    }

    // Back to list
    function showCycleCountsList() {
      detailsContainer.classList.add('hidden');
      cycleCountsContainer.parentElement.classList.remove('hidden');
      renderCycleCounts();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      renderCycleCounts();
      
      backToList.addEventListener('click', showCycleCountsList);
      completeCountButton.addEventListener('click', completeCycleCount);
      applyAdjustmentsButton.addEventListener('click', applyAdjustments);
      searchInput.addEventListener('input', renderCycleCounts);
      statusFilter.addEventListener('change', renderCycleCounts);
      modalCancel.addEventListener('click', () => countItemModal.classList.add('hidden'));
      modalSave.addEventListener('click', saveCountRecord);
    });
  </script>
</body>
</html>